<nz-modal
  [(nzVisible)]="isVisible"
  nzTitle="View Task"
  [nzWidth]="modalWidth"
  [nzStyle]="modalStyle"
  [nzBodyStyle]="{ background: '#333232' }"
  (nzOnCancel)="isVisible = false"
>
  <ng-container *nzModalContent>
    @if (model) {
      <div style="font-size: 15px">
        <div>
          <div class="d-flex w-100 justify-content-between align-items-center">
            <div class="title">{{ model.name }}</div>

            @if (model.ownerType === "family") {
              <fa-icon style="color: grey" class="fa-lg" [icon]="household"></fa-icon>
            }
            @if (model.ownerType === "user") {
              <fa-icon style="color: grey" class="fa-lg" [icon]="personal"></fa-icon>
            }
          </div>

          @if (model.description) {
            <div class="mt-3 ps-1">
              {{ model.description }}
            </div>
          }

          <nz-divider></nz-divider>

          @if (model.recurring) {
            <div class="d-flex w-100 justify-content-between">
              <div>Recurs:</div>
              <div>Every {{ model | frequencyToString }}</div>
            </div>
          }

          <div class="d-flex align-items-center justify-content-between w-100">
            <div>{{ model.recurring ? "Next due date" : "Due date" }}:</div>

            @if (model.isActive) {
              <div>{{ model.dueDate | date }}, {{ model.dueDate | dueDateHumanReadable }}</div>
            }

            @if (!model.isActive) {
              <div class="text-warning">Paused</div>
            }
          </div>
        </div>

        @if (familiesStore.isPerTaskPointStrategy() && model.taskPoint !== undefined) {
          <div class="d-flex w-100 justify-content-between">
            <div>Worth:</div>

            <div>
              <span style="color: {{ model.taskPoint | taskPointColor }}"> {{ model.taskPoint }}</span>
              {{ "point" + (model.taskPoint !== 1 ? "s" : "") }}
            </div>
          </div>

          <div class="d-flex w-100 justify-content-between">
            <div>Priority:</div>

            <div class="d-flex">
              <fa-icon class="me-2" style="color: {{ model.priority === 0 ? 'grey' : '#922724' }}" [icon]="flag"></fa-icon>
              <div>{{ model.priority === 0 ? "Normal" : "High" }}</div>
            </div>
          </div>
        }

        @if (model.recurring) {
          <div>
            <nz-divider></nz-divider>

            <div (click)="showHistory = !showHistory" class="d-flex justify-content-between align-items-center cursor-pointer">
              <div class="">
                Task History
                @if (model.taskHistory) {
                  <span>({{ model.taskHistory.length }})</span>
                }
              </div>

              @if (!showHistory) {
                <fa-icon [icon]="arrowDown"></fa-icon>
              }
              @if (showHistory) {
                <fa-icon [icon]="arrowUp"></fa-icon>
              }
            </div>

            @if (showHistory) {
              <div class="ms-4">
                <div class="py-1">
                  @if (loadingHistory) {
                    <div style="height: 25px" class="d-flex w-100 justify-content-center align-items-center">
                      <nz-spin></nz-spin>
                    </div>
                  }
                  @if (!loadingHistory && model.taskHistory) {
                    <div>
                      @if (model.taskHistory.length === 0) {
                        <div style="font-style: italic">No History</div>
                      }
                      @if (model.taskHistory.length > 0) {
                        <div>
                          @for (taskHistory of model.taskHistory; track taskHistory.id) {
                            <div class="w-100 d-flex pt-2">
                              <div style="width: 90px">{{ taskHistory.completedAt | date }}</div>
                              <div class="mx-4">-</div>
                              <div style="font-style: italic">{{ taskHistory.completedByName }}</div>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </ng-container>

  <div *nzModalFooter class="d-flex justify-content-between">
    <div>
      <button
        nz-button
        nzType="primary"
        nzDanger
        nz-popconfirm
        (nzOnConfirm)="deleteTask()"
        nzPopconfirmTitle="Are you sure?"
        [nzLoading]="deleting"
        [disabled]="deleting"
      >
        Delete
      </button>
    </div>

    <div>
      <button nz-button nzType="primary" (click)="editTaskClicked()" [disabled]="deleting">Edit</button>

      <button nz-button nzType="default" (click)="isVisible = false" [disabled]="deleting">Close</button>
    </div>
  </div>
</nz-modal>
